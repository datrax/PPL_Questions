<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPL Exam Training</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .active {
            display: block;
        }

        .inactive {
            display: none;
        }

        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: blue;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }


        .seventy-percent-height {
            max-height: 70vh;
        }

        /* When the checkbox is checked, change the background and the slider position */
        input:checked+.slider {
            background-color: #4caf50;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
</head>

<body class="bg-gray-100 flex justify-center min-h-screen">

    <!-- Main Screen -->
    <div id="main-screen" class="container mx-auto p-5 bg-white rounded-lg shadow-md active">
        <div class="mt-8 text-center mb-4">
            <p class="text-gray-600 text-lg">
                This is a test exam tool for the Polish PPL license. All the questions are taken from
                <a href="https://www.ulc.gov.pl/_download/personel_lotniczy/lke/ppla_eng.pdf"
                    class="text-blue-500 underline" target="_blank">Polish FAA</a>.
            </p>
        </div>

        <!-- Mode Switch -->
        <div class="flex items-center justify-center mb-6">
            <span id="mode-title" class="text-gray-600 text-lg mr-4">Learn Mode</span>
            <label class="switch">
                <input type="checkbox" id="mode-toggle">
                <span class="slider"></span>
            </label>
            <span class="text-gray-600 text-lg ml-4">Exam Mode</span>
        </div>
        <h1 class="text-3xl text-center text-gray-600 mb-6">Select a Category</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="45" data-questions="28" data-category="PL010" data-category-name="PL010 Air Law">PL010 Air
                Law <br><span class="text-sm">Time: 00:45 | Questions: 28</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="30" data-questions="16" data-category="PL020"
                data-category-name="PL020 Aircraft General Knowledge">PL020 Aircraft General Knowledge <br><span
                    class="text-sm">Time: 00:30 | Questions: 16</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="60" data-questions="20" data-category="PL030"
                data-category-name="PL030 Flight Performance and Planning">PL030 Flight Performance and Planning
                <br><span class="text-sm">Time: 01:00 | Questions: 20</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="30" data-questions="12" data-category="PL040"
                data-category-name="PL040 Human Performance and Limitations">PL040 Human Performance and Limitations
                <br><span class="text-sm">Time: 00:30 | Questions: 12</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="30" data-questions="12" data-category="PL050" data-category-name="PL050 Meteorology">PL050
                Meteorology <br><span class="text-sm">Time: 00:30 | Questions: 12</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="60" data-questions="24" data-category="PL060" data-category-name="PL060 Navigation">PL060
                Navigation <br><span class="text-sm">Time: 01:00 | Questions: 24</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="30" data-questions="12" data-category="PL070"
                data-category-name="PL070 Operational Procedures">PL070 Operational Procedures <br><span
                    class="text-sm">Time: 00:30 | Questions: 12</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="45" data-questions="16" data-category="PL080"
                data-category-name="PL080 Principles of Flight">PL080 Principles of Flight <br><span
                    class="text-sm">Time: 00:45 | Questions: 16</span></button>
            <button
                class="category-btn p-5 bg-white border-2 border-gray-500 rounded-lg shadow hover:bg-gray-500 hover:text-white transition duration-300"
                data-time="30" data-questions="12" data-category="PL090" data-category-name="PL090 Communications">PL090
                Communications <br><span class="text-sm">Time: 00:30 | Questions: 12</span></button>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="lg:container mx-auto p-5 bg-white rounded-lg shadow-md inactive flex">
        <!-- Sidebar for Question Navigation -->
        <div class="w-3/12 p-4 border-r border-gray-300">
            <div id="question-navigation" class="flex flex-wrap flex-raw justify-center items-baseline space-y-2 seventy-percent-height overflow-auto">
                <!-- Dynamic question numbers will be added here -->
            </div>
            <div class="w-full flex flex-col mt-4">
                <button id="home-btn"
                    class="mt-4 block bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition duration-300"
                    onclick="resetAnswers()">Reset All</button>
                <button id="home-btn"
                    class="mt-4 block bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-300"
                    onclick="returnToHome()">Home</button>

            </div>
        </div>

        <div class="w-9/12 p-4">
            <h1 id="selected-category-name" class="text-xl text-center mb-2 font-semibold"></h1>
            <h1 id="question-code" class="text-2xl text-center mb-4"></h1>
            <h1 id="question-number" class="text-2xl text-center mb-4"></h1>
            <p id="time-left" class="text-lg text-center mb-4"></p>
            <div class="question-container mb-6">
                <p id="question-text" class="font-bold text-lg mb-4"></p>
                <div id="answers" class="space-y-4"></div>
            </div>
            <div class="w-full flex justify-between mt-4">
                <button id="back-btn"
                    class="bg-yellow-500 text-white py-2 px-4 rounded hover:bg-yellow-600 transition duration-300"
                    onclick="goBack()">Back</button>
                <button id="next-btn"
                    class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-300"
                    onclick="nextButton()">Next</button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="container mx-auto p-5 bg-white rounded-lg shadow-md inactive">
        <h1 class="text-2xl text-center mb-4">Quiz Finished!</h1>
        <p class="text-xl text-center">Your Score: <span id="score" class="font-bold"></span>%</p>
        <table class="min-w-full mt-4 border-collapse border border-gray-200">
            <thead>
                <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-1 py-2">Code</th>
                    <th class="border border-gray-300 px-2 py-2">Question</th>
                    <th class="border border-gray-300 px-3 py-2">Your Answer</th>
                    <th class="border border-gray-300 px-3 py-2">Correct Answer</th>
                </tr>
            </thead>
            <tbody id="review-table">
            </tbody>
        </table>
        <button id="restart-btn"
            class="mt-4 bg-blue-500 text-white py-2 px-4 rounded hover:bg-green-600 transition duration-300"
            onclick="returnToHomeFromResult()">Return to Home</button>
    </div>

    <script>
        let questions = [];
        let currentQuestionIndex = 0;
        let timer;
        let timeLeft = 0;
        let quizQuestions = [];
        let selectedCategoryName = '';
        let learnMode = true;
        let lastSelectedQuestionCard = null;
        let hasSwitched = false;


        const modeToggle = document.getElementById('mode-toggle');

        modeToggle.addEventListener('change', () => {
            if (modeToggle.checked) {
                learnMode = false;
            } else {
                learnMode = true;
            }
        });

        // Fetch JSON data
        fetch('https://raw.githubusercontent.com/datrax/PPL_Questions/refs/heads/master/PPLQuestionsConverter/questions.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Something went wrong: ' + response.statusText);
                }
                return response.json();  // Parse the JSON from the response
            })
            .then(data => {
                questions = data;  // Store all questions
            })
            .catch(err => {
                alert('Something went wrong: ' + err);
            });


        // Start quiz based on selected category
        document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', () => {
                const selectedCategory = button.getAttribute('data-category');
                selectedCategoryName = button.getAttribute('data-category-name');
                const numberOfQuestions = parseInt(button.getAttribute('data-questions'));
                timeLeft = parseInt(button.getAttribute('data-time')) * 60;
                startQuiz(selectedCategory, numberOfQuestions);
            });
        });

        // Function to start the quiz
        function startQuiz(selectedCategory, numberOfQuestions) {
            hasSwitched = false;
            document.getElementById('main-screen').classList.add('inactive');
            document.getElementById('quiz-screen').classList.remove('inactive');
            document.getElementById('selected-category-name').innerText = selectedCategoryName;
            document.getElementById('question-navigation').innerHTML = '';

            if (learnMode) {
                quizQuestions = JSON.parse(localStorage.getItem(selectedCategoryName));
                if (!quizQuestions) {
                    quizQuestions = questions.filter(q => q.QuestionCode.startsWith(selectedCategory));
                    saveCategoryQuestions();
                }

                currentQuestionIndex = localStorage.getItem(selectedCategoryName + "-index") ?? 0;
            }
            else {
                quizQuestions =
                    shuffleArray(questions.filter(q => q.QuestionCode.startsWith(selectedCategory))).slice(0, numberOfQuestions);
                quizQuestions.forEach((question, index) => {
                    question.selectedAnswer = '';
                });
                currentQuestionIndex = 0;
            }
            // Populate the question navigation sidebar
            quizQuestions.forEach((question, index) => {
                const questionNumberElement = document.createElement('button');
                questionNumberElement.innerText = index + 1;
                questionNumberElement.classList.add('bg-gray-200', 'rounded-full', 'py-1', 'px-1', 'mr-1', 'hover:border-gray-800', 'transition', 'duration-300', 'border-2', 'border-solid', 'border-gray-200', 'w-12');
                if (question.selectedAnswer) {
                    if (question.Answer1 == question.selectedAnswer) {
                        questionNumberElement.classList.add('bg-green-500');
                    }
                    else {
                        questionNumberElement.classList.add('bg-red-500');
                    }
                }
                questionNumberElement.onclick = () => jumpToQuestion(index);
                document.getElementById('question-navigation').appendChild(questionNumberElement);
            });

            // Start the first question

            showQuestion();
            if (!learnMode) {
                startTimer();
            }
        }

        function saveCategoryQuestions() {
            if (!learnMode) return;
            localStorage.setItem(selectedCategoryName, JSON.stringify(quizQuestions));
            localStorage.setItem(selectedCategoryName + "-index", currentQuestionIndex);
        }

        // Function to show the question
        function showQuestion() {
            saveCategoryQuestions();

            const question = quizQuestions[currentQuestionIndex];

            lastSelectedQuestionCard?.classList?.remove('border-yellow-500');
            lastSelectedQuestionCard?.classList?.add('hover:border-gray-800');
            lastSelectedQuestionCard = document.getElementById('question-navigation').getElementsByTagName('button')[currentQuestionIndex];
            lastSelectedQuestionCard.classList.add('border-yellow-500');
            lastSelectedQuestionCard?.classList?.remove('hover:border-gray-800');

            document.getElementById('question-number').innerText = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
            document.getElementById('question-code').innerText = question.QuestionCode;
            document.getElementById('question-text').innerText = question.Question;
            const answers = shuffleArray([question.Answer1, question.Answer2, question.Answer3, question.Answer4]);
            const answersContainer = document.getElementById('answers');
            answersContainer.innerHTML = '';

            answers.forEach(answer => {
                const answerButton = document.createElement('button');
                answerButton.innerHTML = answer;
                answerButton.className += (' w-full p-4 border-2 border-gray-500 rounded hover:bg-gray-500 hover:text-white transition duration-300');
                answerButton.onclick = () => selectAnswer(answer);
                answersContainer.appendChild(answerButton);
            });
            highlightAnswers();
        }

        // Function to select an answer
        function selectAnswer(answer) {
            var correctAnswer = quizQuestions[currentQuestionIndex].Answer1;
            quizQuestions[currentQuestionIndex].selectedAnswer = answer; // Track selected answer
            highlightAnswers();

            var questionButton = document.getElementById('question-navigation').getElementsByTagName('button')[currentQuestionIndex];
            questionButton.classList.remove('bg-red-500', 'bg-green-500', 'border-yellow-500');

            if (correctAnswer === answer) {
                questionButton.classList.add('bg-green-500');
            }
            else {
                questionButton.classList.add('bg-red-500');
            }

            if (currentQuestionIndex < quizQuestions.length - 1) {
                hasSwitched = false;
                setTimeout(autoNextClick, 1500);
            }
        }

        function highlightAnswers() {
            var selectedAnswer = quizQuestions[currentQuestionIndex].selectedAnswer;
            if (selectedAnswer == '') return;

            var button = Array.from(document.getElementById('answers').getElementsByTagName('button')).find(btn => btn.innerHTML === selectedAnswer);
            button.classList.remove('bg-red-500', 'bg-green-500', 'hover:bg-gray-500');

            if (selectedAnswer != quizQuestions[currentQuestionIndex].Answer1) {
                button.classList.add('bg-red-500');
            } else {
                button.classList.add('bg-green-500');
            }

        }

        // Function to move to the next question
        function nextButton() {
            hasSwitched = true;
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            } else {
                finishQuiz();
            }
        }

        // Function to move to the next question
        function autoNextClick() {
            if (hasSwitched) {
                hasSwitched = false;
                return;
            }
            else {
                currentQuestionIndex++;
                showQuestion();
            }
        }

        function resetAnswers() {
            quizQuestions.forEach((question, index) => {
                question.selectedAnswer = '';
            });
            currentQuestionIndex = 0;
            saveCategoryQuestions();
            startQuiz();
        }

        // Function to finish the quiz
        function finishQuiz() {
            clearInterval(timer);
            document.getElementById('quiz-screen').classList.add('inactive');
            document.getElementById('result-screen').classList.remove('inactive');
            const correctCount = quizQuestions.reduce((count, question) => count + (question.selectedAnswer === question.Answer1 ? 1 : 0), 0);
            document.getElementById('score').innerText = ((correctCount / quizQuestions.length) * 100).toFixed(2);
            generateReviewTable();
        }

        // Function to generate review table
        function generateReviewTable() {
            const reviewTable = document.getElementById('review-table');
            reviewTable.innerHTML = '';

            quizQuestions.forEach((question, index) => {
                var isCorrect = question.selectedAnswer == question.Answer1;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-1 py-2">${question.QuestionCode}</td>
                    <td class="border border-gray-300 px-2 py-2">${question.Question}</td>
                    <td class="border border-gray-300 px-3 py-2 ${isCorrect ? 'bg-green-500' : 'bg-red-500'}">${question.selectedAnswer || 'N/A'}</td>
                    <td class="border border-gray-300 px-3 py-2">${isCorrect ? '' : question.Answer1}</td>
                `;
                reviewTable.appendChild(row);
            });
        }

        // Function to start the timer
        function startTimer() {
            const timeLeftDisplay = document.getElementById('time-left');
            timer = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timeLeftDisplay.innerText = `Time Left: ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    finishQuiz();
                }
            }, 1000);
        }

        // Function to return to home
        function returnToHome() {
            clearInterval(timer);
            document.getElementById('quiz-screen').classList.add('inactive');
            document.getElementById('main-screen').classList.remove('inactive');
        }

        // Function to restart quiz
        function returnToHomeFromResult() {
            currentQuestionIndex = 0;
            document.getElementById('result-screen').classList.add('inactive');
            document.getElementById('main-screen').classList.remove('inactive');
        }

        // Function to go back to the previous question
        function goBack() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        // Function to jump to a specific question
        function jumpToQuestion(index) {
            hasSwitched = true;
            currentQuestionIndex = index;
            showQuestion();
        }


        // Utility function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>

</html>